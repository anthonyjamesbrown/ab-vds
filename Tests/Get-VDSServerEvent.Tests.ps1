$ScriptName = $MyInvocation.MyCommand.Name
$ScriptPath = $PSScriptRoot
$ScriptUnderTest = if($ScriptName.EndsWith(".Tests.ps1")) { $ScriptName.Replace(".Tests.ps1", ".ps1") }
$TestScriptPath = Resolve-Path $ScriptPath\..\VDS\Public
$FunctionName = $ScriptUnderTest.Replace(".ps1", "")

. "$TestScriptPath\$ScriptUnderTest"

Describe "Unit Test: $FunctionName" {
    It "Test $FunctionName`: Only one warning record should be returned for wprsedifvds001v.asurion.org. " {
        
        $JsonObject = '{"914d3436-0f5f-4239-a76d-bcaaab111c95":{"2018-11-08 22:25:31.465":{"INFO":{"1":"Frontend started.","2":"Server started."}},"2018-11-08 22:25:33.996":{"INFO":{"3":"Node 914d3436-0f5f-4239-a76d-bcaaab111c95 is up, register tlog replication."}},"2018-11-08 22:31:37.383":{"INFO":{"4":"IndexHTTPFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] Closing index with 215996 entries"}},"2018-11-08 22:34:49.106":{"INFO":{"6":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): session=id=2 version=1 files={index=[fileName=_0.cfe size=405 crc=2306564232, fileName=_0.si size=373 crc=1543502431, fileName=_0.cfs size=1394074533 crc=1662767082, fileName=segments_1 size=136 crc=3673080043]}","7":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): requiredFiles=[fileName=_0.cfe size=405 crc=2306564232, fileName=_0.si size=373 crc=1543502431, fileName=_0.cfs size=1394074533 crc=1662767082, fileName=segments_1 size=136 crc=3673080043]","8":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): replicating file=_0.cfe"}},"2018-11-08 22:34:49.122":{"INFO":{"9":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): replicating file=_0.si"}},"2018-11-08 22:34:49.138":{"INFO":{"10":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): replicating file=_0.cfs"}},"2018-11-08 22:35:26.706":{"INFO":{"11":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): replicating file=segments_1"}},"2018-11-08 22:35:26.883":{"INFO":{"12":"IndexHTTPFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] Opening index..."}},"2018-11-08 22:35:26.892":{"INFO":{"13":"IndexHTTPFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] Loaded with 170927 entries - revision: 0x1MMTlog=true - RAMTlog=true"}},"2018-11-12 21:48:42.106":{"INFO":{"15":"Node a80969d3-0f8c-4e0f-9a09-0579e92023f1 is down, unregister tlog replication."}},"2018-11-08 22:34:46.28":{"WARN":{"5":"IndexCluster - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] Leader index not ready yet. Retrying [1s countDown=240]"}},"2018-11-11 07:18:13.139":{"WARN":{"14":"Large attribute value: unmergedatts@CN=Legacy Asurion-ALL,OU=NLE,OU=Disabled,dc=int,dc=asurion,dc=com (12396)- the non indexed attribute configuration should be considered to improve performance"}}},"aaeccabc-7af2-4fcf-b2db-020690112f5c":{"2018-11-20 01:00:38.202":{"INFO":{"1":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backup done."}},"2018-11-21 01:00:32.876":{"INFO":{"2":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backing up..."}},"2018-11-21 01:00:32.877":{"INFO":{"3":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backup done."}},"2018-11-22 01:00:33.748":{"INFO":{"4":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backing up..."}},"2018-11-22 01:00:33.749":{"INFO":{"5":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backup done."}},"2018-11-23 01:00:36.989":{"INFO":{"6":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backing up..."}},"2018-11-23 01:00:36.990":{"INFO":{"7":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backup done."}},"2018-11-24 01:00:33.710":{"INFO":{"8":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backing up..."}},"2018-11-24 01:00:33.712":{"INFO":{"9":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backup done."}},"2018-11-25 01:00:35.37":{"INFO":{"10":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backing up..."}},"2018-11-25 01:00:35.38":{"INFO":{"11":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backup done."}},"2018-11-26 01:00:34.433":{"INFO":{"12":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backing up..."}},"2018-11-26 01:00:34.434":{"INFO":{"13":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backup done."}},"2018-11-27 01:00:39.36":{"INFO":{"14":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backing up..."}},"2018-11-27 01:00:39.37":{"INFO":{"15":"IndexLeader - [ou_jcaprod_ou_apps_o_data - FS:E:\\radiantone\\vds\\vds_server\\data\\ou_jcaprod_ou_apps_o_data\\] Backup done."}}},"a80969d3-0f8c-4e0f-9a09-0579e92023f1":{"2018-11-08 22:25:33.989":{"INFO":{"1":"Node 914d3436-0f5f-4239-a76d-bcaaab111c95 is up, register tlog replication."}},"2018-11-08 22:31:37.504":{"INFO":{"2":"IndexHTTPFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] Closing index with 215996 entries"}},"2018-11-08 22:34:46.8":{"WARN":{"3":"IndexCluster - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] Leader index not ready yet. Retrying [1s countDown=240]"}},"2018-11-08 22:34:49.86":{"INFO":{"4":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): session=id=1 version=1 files={index=[fileName=_0.cfe size=405 crc=2306564232, fileName=_0.si size=373 crc=1543502431, fileName=_0.cfs size=1394074533 crc=1662767082, fileName=segments_1 size=136 crc=3673080043]}"}},"2018-11-08 22:34:49.101":{"INFO":{"5":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): requiredFiles=[fileName=_0.cfe size=405 crc=2306564232, fileName=_0.si size=373 crc=1543502431, fileName=_0.cfs size=1394074533 crc=1662767082, fileName=segments_1 size=136 crc=3673080043]","6":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): replicating file=_0.cfe"}},"2018-11-08 22:34:49.164":{"INFO":{"7":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): replicating file=_0.si"}},"2018-11-08 22:34:49.180":{"INFO":{"8":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): replicating file=_0.cfs"}},"2018-11-08 22:35:22.118":{"INFO":{"9":"IndexFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] doUpdateOffline(): replicating file=segments_1"}},"2018-11-08 22:35:22.196":{"INFO":{"10":"IndexHTTPFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] Opening index..."}},"2018-11-08 22:35:22.211":{"INFO":{"11":"IndexHTTPFollower - [dc_int_dc_asurion_dc_com - FS:E:\\radiantone\\vds\\vds_server\\data\\dc_int_dc_asurion_dc_com\\] Loaded with 170927 entries - revision: 0x1MMTlog=true - RAMTlog=true"}},"2018-11-12 21:49:22.540":{"INFO":{"12":"Connection state changed to: LOST"}},"2018-11-12 21:49:22.556":{"INFO":{"13":"Connection state changed to: READ_WRITE"}},"2018-11-12 21:49:22.559":{"INFO":{"14":"Node a80969d3-0f8c-4e0f-9a09-0579e92023f1 is down, unregister tlog replication."}},"2018-11-19 11:05:18.823":{"INFO":{"15":"Off HEAP memory info - Free off heap=5 GB - hdap stores size=6 GB"}}}}'

        mock 'Invoke-VDSAdminAPIRestMethod' -MockWith { $JsonObject | ConvertFrom-Json }

        $Result = Get-VDSServerEvent -Server 'vds.prod.asurion.net' | Where-Object { $_.Name -eq 'wprsedifvds001v.asurion.org' -and $_.Type -eq 'WARN' }
        $Result.Count | Should -Be 1
    }
}


